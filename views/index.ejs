<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-translate="page-title-inventory">
      Gold Jewelry Inventory Tracker
    </title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 data-translate="header-title">Gold Jewelry Inventory</h1>
        <div id="language-toggle"></div>
      </div>

      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="summary-card">
          <h3 data-translate="inventory-value">Inventory</h3>
          <div class="summary-value"><%= inventory.length %></div>
          <div class="summary-label" data-translate="summary-items">items</div>
        </div>
        <div class="summary-card">
          <h3 data-translate="inventory-value">Value</h3>
          <div class="summary-value">
            $<%= (totalInventoryValue || 0).toFixed(2) %>
          </div>
          <div class="summary-label" data-translate="summary-market-value">
            market value
          </div>
        </div>
        <div class="summary-card">
          <h3 data-translate="total-sales">Sales</h3>
          <div class="summary-value">$<%= totalSales.toFixed(2) %></div>
          <div class="summary-label" data-translate="summary-revenue">
            revenue
          </div>
        </div>
        <div class="summary-card">
          <h3 data-translate="total-profit">Profit</h3>
          <div class="summary-value">$<%= totalProfit.toFixed(2) %></div>
          <div class="summary-label" data-translate="summary-earned">
            earned
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <a href="/add-item" class="btn primary" data-translate="add-new-item"
          >Add Item</a
        >
        <a href="/settings" class="btn secondary" data-translate="settings"
          >Settings</a
        >
      </div>

      <!-- Inventory Section -->
      <div class="section">
        <h2 data-translate="current-inventory">Inventory</h2>
        <% if (inventory.length === 0) { %>
        <div class="empty-state">
          <p data-translate="no-inventory">No items in inventory yet.</p>
          <a
            href="/add-item"
            class="btn primary"
            data-translate="add-first-item"
            >Add Your First Item</a
          >
        </div>
        <% } else { %>
        <div class="table-container">
          <table class="inventory-table">
            <thead>
              <tr>
                <th data-translate="item-name">Item Name</th>
                <th data-translate="item-type">Type</th>
                <th data-translate="item-weight">Weight (g)</th>
                <th data-translate="item-purity">Purity</th>
                <th data-translate="item-karat">Karat</th>
                <th data-translate="item-cost">Cost</th>
                <th data-translate="item-market-value">Market Value</th>
                <th data-translate="item-dealer-value">Dealer Value</th>
                <th data-translate="item-actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% inventory.forEach(function(item) { %>
              <tr>
                <td><%= item.name %></td>
                <td><%= item.type %></td>
                <td><%= item.weight.toFixed(2) %></td>
                <td><%= item.purity.toFixed(1) %>%</td>
                <td>
                  <strong
                    ><%= item.karat || getKaratFromPurity(item.purity)
                    %></strong
                  >
                </td>
                <td>$<%= item.cost.toFixed(2) %></td>
                <td>
                  $<%= item.marketValue ? item.marketValue.toFixed(2) : 'N/A' %>
                </td>
                <td>
                  $<%= item.dealerValue ? item.dealerValue.toFixed(2) : 'N/A' %>
                </td>
                <td>
                  <a
                    href="/sell-item/<%= item.id %>"
                    class="btn small primary"
                    data-translate="sell"
                    >üí∞ Sell</a
                  >
                  <button
                    onclick="deleteItem('<%= item.id %>')"
                    class="btn small danger"
                    data-translate="delete"
                  >
                    üóëÔ∏è
                  </button>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
        <% } %>
      </div>

      <!-- Sales Section -->
      <div class="section">
        <h2 data-translate="sales-title">üí∞ Recent Sales</h2>
        <% if (sales.length === 0) { %>
        <div class="empty-state">
          <p data-translate="no-sales">No sales recorded yet.</p>
        </div>
        <% } else { %>
        <div class="table-container">
          <table class="sales-table">
            <thead>
              <tr>
                <th data-translate="sale-item">Item</th>
                <th data-translate="sale-weight">Weight (g)</th>
                <th data-translate="sale-purity">Purity</th>
                <th data-translate="sale-karat">Karat</th>
                <th data-translate="sale-cost">Cost</th>
                <th data-translate="sale-price">Sale Price</th>
                <th data-translate="sale-profit">Profit</th>
                <th data-translate="sale-buyer">Buyer</th>
                <th data-translate="sale-date">Date</th>
              </tr>
            </thead>
            <tbody>
              <% sales.slice(-10).reverse().forEach(function(sale) { %>
              <tr>
                <td><%= sale.itemName %></td>
                <td><%= sale.weight.toFixed(2) %></td>
                <td><%= sale.purity.toFixed(1) %>%</td>
                <td>
                  <strong
                    ><%= sale.karat || getKaratFromPurity(sale.purity)
                    %></strong
                  >
                </td>
                <td>$<%= sale.cost.toFixed(2) %></td>
                <td>$<%= sale.price.toFixed(2) %></td>
                <td class="<%= sale.profit >= 0 ? 'positive' : 'negative' %>">
                  $<%= sale.profit.toFixed(2) %>
                </td>
                <td><%= sale.buyer %></td>
                <td><%= new Date(sale.dateSold).toLocaleDateString() %></td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
        <% } %>
      </div>

      <!-- Gold Price Information -->
      <div class="section">
        <h2 data-translate="gold-market">Gold Market</h2>
        <div
          class="summary-cards"
          style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"
        >
          <div class="summary-card">
            <h3 data-translate="gold-price">Gold Price</h3>
            <div class="summary-value">
              $<%= (settings && settings.goldPricePerOunce ?
              settings.goldPricePerOunce : 3314.92).toFixed(2) %>
            </div>
            <div class="summary-label" data-translate="per-ounce">
              per ounce
            </div>
          </div>
          <div class="summary-card">
            <h3 data-translate="per-gram">Per Gram</h3>
            <div class="summary-value">
              $<%= ((settings && settings.goldPricePerOunce ?
              settings.goldPricePerOunce : 3314.92) / 31.1035).toFixed(2) %>
            </div>
            <div class="summary-label" data-translate="24k-gold">24K gold</div>
          </div>
          <div class="summary-card">
            <h3 data-translate="updated">Updated</h3>
            <div class="summary-value">
              <%= settings && settings.lastUpdated ? new
              Date(settings.lastUpdated).toLocaleDateString() : new
              Date().toLocaleDateString() %>
            </div>
            <div class="summary-label">
              <%= settings && settings.lastUpdated ? new
              Date(settings.lastUpdated).toLocaleTimeString() : new
              Date().toLocaleTimeString() %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/js/language.js"></script>
    <script>
      function deleteItem(itemId) {
        const confirmMessage =
          LanguageManager.currentLanguage === "es"
            ? LanguageManager.translations.es["delete-confirm"]
            : LanguageManager.translations.en["delete-confirm"];

        if (confirm(confirmMessage)) {
          fetch(`/item/${itemId}`, {
            method: "DELETE",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                location.reload();
              } else {
                alert("Error deleting item");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error deleting item");
            });
        }
      }

      // Helper function to get karat from purity (fallback for items without karat)
      function getKaratFromPurity(purity) {
        if (purity >= 99.0) return "24K";
        if (purity >= 90.0) return "22K";
        if (purity >= 70.0) return "18K";
        if (purity >= 55.0) return "14K";
        if (purity >= 40.0) return "10K";
        if (purity >= 35.0) return "9K";
        return "Custom";
      }
    </script>
  </body>
</html>
